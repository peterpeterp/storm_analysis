

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TC_detection &mdash; storm_analysis  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> storm_analysis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../content.html">Modules</a></li>
</ul>

            
          
    <a href="genindex.html">Index</a>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">storm_analysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>TC_detection</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for TC_detection</h1><div class="highlight"><pre>
<span></span><span class="c1"># Author: Peter Pfleiderer &lt;peter.pfleiderer@climateanalytics.org&gt;</span>
<span class="c1">#</span>
<span class="c1"># License: GNU General Public License v3.0</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">glob</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span><span class="nn">collections</span><span class="o">,</span><span class="nn">gc</span><span class="o">,</span><span class="nn">calendar</span><span class="o">,</span><span class="nn">weakref</span><span class="o">,</span><span class="nn">resource</span><span class="o">,</span><span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="k">import</span> <span class="n">Dataset</span><span class="p">,</span><span class="n">num2date</span>
<span class="kn">import</span> <span class="nn">dimarray</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">ndimage</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="n">peak_local_max</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;plasma&quot;</span><span class="p">))</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/Users/peterpfleiderer/Documents/Projects/tropical_cyclones/tc_detection&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">TC_support</span> <span class="k">import</span> <span class="o">*</span> <span class="p">;</span> <span class="n">reload</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;TC_support&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">unit_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    get the unit vector from a vector</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">angle_between</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    get angle between two vectors</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">v1_u</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">v2_u</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1_u</span><span class="p">,</span> <span class="n">v2_u</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

<div class="viewcode-block" id="tc_tracks"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks">[docs]</a><span class="k">class</span> <span class="nc">tc_tracks</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class can be used to detect tropical cyclones. Depending on the method used to detect storm snapshots different input data is required. Currently two storm snapshot detecion methods are implemented: :meth:`detect_contours` or :meth:`detect_knutson2007`. When adding new methods you should stick to the output format of these methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="tc_tracks.__init__"><a class="viewcode-back" href="../_autosummary/TC_detection.tc_tracks.html#TC_detection.tc_tracks.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">VO</span><span class="p">,</span><span class="n">Wind10</span><span class="p">,</span><span class="n">MSLP</span><span class="p">,</span><span class="n">MSLP_smoothed</span><span class="p">,</span><span class="n">SST</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">T_diff</span><span class="p">,</span><span class="n">land_mask</span><span class="p">,</span><span class="n">lats</span><span class="p">,</span><span class="n">lons</span><span class="p">,</span><span class="n">time_</span><span class="p">,</span><span class="n">dates</span><span class="p">,</span><span class="n">identifier</span><span class="p">,</span><span class="n">working_dir</span><span class="p">,</span><span class="n">time_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="o">=</span><span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">=</span><span class="n">working_dir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span><span class="o">+</span><span class="n">working_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">working_dir</span><span class="o">+</span><span class="s1">&#39;/track_surrounding&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span><span class="o">+</span><span class="n">working_dir</span><span class="o">+</span><span class="s1">&#39;/track_surrounding&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">working_dir</span><span class="o">+</span><span class="s1">&#39;/track_path&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span><span class="o">+</span><span class="n">working_dir</span><span class="o">+</span><span class="s1">&#39;/track_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">working_dir</span><span class="o">+</span><span class="s1">&#39;/track_evolution&#39;</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span><span class="o">+</span><span class="n">working_dir</span><span class="o">+</span><span class="s1">&#39;/track_evolution&#39;</span><span class="p">)</span>

        <span class="c1"># input fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="o">=</span><span class="n">lats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="o">=</span><span class="n">lons</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_VO</span><span class="o">=</span><span class="n">VO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Wind10</span><span class="o">=</span><span class="n">Wind10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="o">=</span><span class="n">MSLP</span>
        <span class="k">if</span> <span class="n">MSLP_smoothed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MSLP_smoothed</span><span class="o">=</span><span class="n">MSLP_smoothed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MSLP_smoothed</span><span class="o">=</span><span class="n">MSLP</span>

        <span class="k">if</span> <span class="n">land_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_land_mask</span><span class="o">=</span><span class="n">land_mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_land_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="mi">0</span><span class="o">+</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">=</span><span class="n">time_</span>
        <span class="k">if</span> <span class="n">time_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_steps</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span><span class="o">=</span><span class="n">time_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dates</span><span class="o">=</span><span class="n">dates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yr_frac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">toYearFraction</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dates</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="o">=</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_T_diff</span><span class="o">=</span><span class="n">T_diff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SST</span><span class="o">=</span><span class="n">SST</span>

        <span class="c1"># tc cat dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obs_tc</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cat_colors</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;#ffffcc&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;#ffe775&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="s1">&#39;#ffc148&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;#ff8f20&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span><span class="s1">&#39;#ff6060&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cat_names</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;tropical storm&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="s1">&#39;Category 1&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;Category 2&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="s1">&#39;Category 3&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="s1">&#39;Category 4&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span><span class="s1">&#39;Category 5&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="tc_tracks.degree_to_step"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.degree_to_step">[docs]</a>    <span class="k">def</span> <span class="nf">degree_to_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">degree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts distances in degrees into steps on the lat-lon grid</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            degree: float [deg]</span>
<span class="sd">                distance to be converted</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            number of steps on the lon-lat grid corresponding to the distance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_step</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">x_step</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">degree</span><span class="o">/</span><span class="p">(</span><span class="n">y_step</span><span class="o">+</span><span class="n">x_step</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="tc_tracks.tc_cat"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.tc_cat">[docs]</a>    <span class="k">def</span> <span class="nf">tc_cat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;pressure&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the category of a storm snapshot based on 10m wind speed or MSLP</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            z: float [hPa or m/s]</span>
<span class="sd">                value tested against TC-categors thresholds</span>
<span class="sd">            method: str [&#39;pressure&#39; or &#39;wind&#39;], default=&#39;pressure&#39;</span>
<span class="sd">                specifies if `z` is a wind-speed or a pressure value</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            cat: int</span>
<span class="sd">                category of the TC form 0-5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">cat__</span><span class="p">(</span><span class="n">zz</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;wind&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&lt;=</span><span class="mi">64</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&gt;</span><span class="mi">64</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&gt;</span><span class="mi">82</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&gt;</span><span class="mi">95</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">3</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&gt;</span><span class="mi">112</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&gt;</span><span class="mi">136</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">5</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zz</span><span class="p">):</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="n">cat</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;pressure&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&gt;=</span><span class="mi">1020</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&lt;</span><span class="mi">1020</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&lt;</span><span class="mi">980</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&lt;</span><span class="mi">965</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">3</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&lt;</span><span class="mi">945</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">zz</span><span class="o">&lt;</span><span class="mi">920</span><span class="p">:</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">5</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zz</span><span class="p">):</span> <span class="n">cat</span><span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="n">cat</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dimarraycls</span><span class="o">.</span><span class="n">DimArray</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">cat__</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span> <span class="k">for</span> <span class="n">zz</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cat__</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></div>

    <span class="c1"># treating ibtracks</span>
<div class="viewcode-block" id="tc_tracks.init_obs_tcs"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.init_obs_tcs">[docs]</a>    <span class="k">def</span> <span class="nf">init_obs_tcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tc_sel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This functions transforms ibtracks input into the format used by plot functions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            tc_sel: dimarray</span>
<span class="sd">                ibtracks loaded as dimarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="o">=</span><span class="n">tc_sel</span>
        <span class="n">tmp_time</span><span class="o">=</span><span class="n">tc_sel</span><span class="p">[</span><span class="s1">&#39;source_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tc_time</span><span class="o">=</span><span class="n">tmp_time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tmp_time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tmp_time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tmp_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tc_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">toYearFraction</span><span class="p">(</span><span class="n">num2date</span><span class="p">(</span><span class="n">tmp_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days since 1858-11-17 00:00:00&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tc_lat</span><span class="o">=</span><span class="n">tc_sel</span><span class="p">[</span><span class="s1">&#39;lat_for_mapping&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="o">=</span><span class="n">tc_sel</span><span class="p">[</span><span class="s1">&#39;lon_for_mapping&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span><span class="o">-=</span><span class="mi">360</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tc_intens</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tc_sel</span><span class="p">[</span><span class="s1">&#39;source_wind&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obs_tc</span><span class="o">=</span><span class="kc">True</span></div>

<div class="viewcode-block" id="tc_tracks.obs_track_info"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.obs_track_info">[docs]</a>    <span class="k">def</span> <span class="nf">obs_track_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">core_radius</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">full_radius</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collects and sves info of input fields around observed tracks</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            core_radius: int, default=3</span>
<span class="sd">                radius of grid-cells around storm center which are going to be analyzed for core specific variables</span>
<span class="sd">            full_radius: int, default=7</span>
<span class="sd">                radius of grid-cells around storm center which are going to be analyzed</span>
<span class="sd">            overwrite:  bool, default=False</span>
<span class="sd">                if False, existing outputfiles of the function are loaded, if True they are overwritten</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            self._obs_track_info: dimarray</span>
<span class="sd">                array containg info at time steps and positions of observed storms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;obs_track_info.nc&#39;</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm &#39;</span><span class="o">+</span><span class="n">out_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">overwrite</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obs_track_info</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">read_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_track_info</span>


        <span class="c1"># convert distances from degrees into grid-cells</span>
        <span class="n">core_radius</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">core_radius</span><span class="p">))</span>
        <span class="n">full_radius</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">full_radius</span><span class="p">))</span>

        <span class="n">obs_summary</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="o">.</span><span class="n">storm</span><span class="p">),</span><span class="mi">200</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">storm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="o">.</span><span class="n">storm</span><span class="p">):</span>
            <span class="n">tmp_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_time</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="n">last_val</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tmp_t</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">last_val</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;wind&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="p">[</span><span class="s1">&#39;source_wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">last_val</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">last_val</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="p">[</span><span class="s1">&#39;source_wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">last_val</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">last_val</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="p">[</span><span class="s1">&#39;source_pres&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">last_val</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_val</span><span class="p">):</span>
                <span class="n">t_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_yr_frac</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_time</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.0004</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">t_</span><span class="o">=</span><span class="n">t_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">])),</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">]))</span>
                    <span class="n">y_core</span><span class="p">,</span><span class="n">x_core</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">area_around</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">core_radius</span><span class="p">)</span>
                    <span class="n">y_full</span><span class="p">,</span><span class="n">x_full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">area_around</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">full_radius</span><span class="p">)</span>
                    <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_VO</span><span class="p">[</span><span class="n">t_</span><span class="p">,</span><span class="n">y_core</span><span class="p">,</span><span class="n">x_core</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="n">t_</span><span class="p">,</span><span class="n">y_core</span><span class="p">,</span><span class="n">x_core</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Wind10</span><span class="p">[</span><span class="n">t_</span><span class="p">,</span><span class="n">y_full</span><span class="p">,</span><span class="n">x_full</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t_</span><span class="p">,</span><span class="n">y_core</span><span class="p">,</span><span class="n">x_core</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T_diff</span><span class="p">[</span><span class="n">t_</span><span class="p">,</span><span class="n">y_core</span><span class="p">,</span><span class="n">x_core</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SST</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_SST</span><span class="p">[</span><span class="n">t_</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                    <span class="n">obs_summary</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_land_mask</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>

        <span class="n">obs_summary</span><span class="o">=</span><span class="n">obs_summary</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">obs_summary</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))),:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obs_track_info</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">DimArray</span><span class="p">(</span><span class="n">obs_summary</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="o">.</span><span class="n">storm</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">obs_summary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),[</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span><span class="s1">&#39;obs_wind&#39;</span><span class="p">,</span><span class="s1">&#39;obs_pres&#39;</span><span class="p">,</span><span class="s1">&#39;VO&#39;</span><span class="p">,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;T_diff&#39;</span><span class="p">,</span><span class="s1">&#39;SST&#39;</span><span class="p">,</span><span class="s1">&#39;land&#39;</span><span class="p">]],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;storm&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;variable&#39;</span><span class="p">])</span>

        <span class="n">da</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;obs_track_info&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_obs_track_info</span><span class="p">})</span><span class="o">.</span><span class="n">write_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

        <span class="c1"># print summary</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Category:</span><span class="se">\t</span><span class="s1">0</span><span class="se">\t\t</span><span class="s1">1</span><span class="se">\t\t</span><span class="s1">2</span><span class="se">\t\t</span><span class="s1">3</span><span class="se">\t\t</span><span class="s1">4</span><span class="se">\t\t</span><span class="s1">5&#39;</span><span class="p">);</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vari</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">),[</span><span class="s1">&#39;VO&#39;</span><span class="p">,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">,</span><span class="s1">&#39;T850&#39;</span><span class="p">,</span><span class="s1">&#39;T500&#39;</span><span class="p">,</span><span class="s1">&#39;SST&#39;</span><span class="p">]):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">);</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                <span class="n">pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs_summary</span><span class="o">==</span><span class="n">cat</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">obs_summary</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">vari</span><span class="p">]))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">);</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_track_info</span></div>

    <span class="c1"># plotting</span>
<div class="viewcode-block" id="tc_tracks.init_map"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.init_map">[docs]</a>    <span class="k">def</span> <span class="nf">init_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">transform</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All plot functions except :meth:`plot_surrounding` plot on the map initialized in this function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            ax: cartopy.mpl.geoaxes.GeoAxesSubplot</span>
<span class="sd">                an axis with cartopy projection. This ax object can be created with a command as `ax = plt.axes(projection=ccrs.PlateCarree())`</span>
<span class="sd">            transform: cartopy.crs, default=ccrs.PlateCarree()</span>
<span class="sd">                this argument will be added to all plot functions to  interprete given lat-lon coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">=</span><span class="n">ax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="o">=</span><span class="n">transform</span></div>

        <span class="c1"># for storm in range(len(self._tc_sel.storm)):</span>
        <span class="c1">#     self._m.plot(self._tc_lon[storm,:],self._tc_lat[storm,:],color=&#39;gray&#39;)</span>

<div class="viewcode-block" id="tc_tracks.plot_on_map"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.plot_on_map">[docs]</a>    <span class="k">def</span> <span class="nf">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">x_in</span><span class="p">,</span><span class="n">y_in</span><span class="p">,</span><span class="n">cat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">latlon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function used to plot tracks or positions on a map (usually the map initialized in :meth:`init_map`)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            ax: cartopy.mpl.geoaxes.GeoAxesSubplot</span>
<span class="sd">                the axes on which to plot. This is usually `self._ax` except when called from :meth:`plot_surrounding`</span>
<span class="sd">            x_in: int or array</span>
<span class="sd">                x-location(s) to be ploted</span>
<span class="sd">            y_in: int or array</span>
<span class="sd">                y-location(s) to be ploted</span>
<span class="sd">            cat: int or array, default=None</span>
<span class="sd">                category of the TC-scale defining the plot-color</span>
<span class="sd">            latlon: bool, default=False</span>
<span class="sd">                if True, `x_in` and `y_in` are lons and lats. If False, they are indices of the `self._lons` and `self._lats` arrays initialized in :meth:`__init__`</span>
<span class="sd">            **kwargs</span>
<span class="sd">                key word arguments used in plot functions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">             ax.plot():</span>
<span class="sd">                the output of the plot command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">latlon</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">x_in</span><span class="p">,</span><span class="n">y_in</span>
        <span class="k">if</span> <span class="n">latlon</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span><span class="n">da</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">dimarraycls</span><span class="o">.</span><span class="n">DimArray</span><span class="p">):</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="n">y_in</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x_in</span><span class="p">]]</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="n">y_in</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x_in</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y_in</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">x_in</span><span class="p">)]</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y_in</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">x_in</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">cat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cat_colors</span><span class="p">[</span><span class="n">cat</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">tmp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="tc_tracks.plot_track_path"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.plot_track_path">[docs]</a>    <span class="k">def</span> <span class="nf">plot_track_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">track</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots an individual track and saves it in `self._working_dir+&#39;track_path/&#39;`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            track: dimarray</span>
<span class="sd">                track saved by :meth:`combine_tracks`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tmp</span><span class="p">,</span><span class="n">txt</span><span class="o">=</span><span class="p">[],[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_tc</span><span class="p">:</span>
            <span class="n">storms</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_yr_frac</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.002</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">storm</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">storms</span><span class="p">):</span>
                <span class="n">tmp</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="p">[</span><span class="n">storm</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lat</span><span class="p">[</span><span class="n">storm</span><span class="p">,:],</span><span class="n">cat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_intens</span><span class="p">[</span><span class="n">storm</span><span class="p">,:],</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;wind&#39;</span><span class="p">),</span><span class="n">latlon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">last_pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="p">[</span><span class="n">storm</span><span class="p">,:]))[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="p">[</span><span class="n">storm</span><span class="p">,</span><span class="n">last_pos</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lat</span><span class="p">[</span><span class="n">storm</span><span class="p">,</span><span class="n">last_pos</span><span class="p">],</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">storm</span><span class="p">,:]),</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">))</span>

        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">))</span>
        <span class="n">tmp</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">cat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dates</span><span class="p">[</span><span class="n">t</span><span class="p">]))</span>

        <span class="c1">#tmp+=self.plot_on_map(self._m,self._detected[:,&#39;x&#39;],self._detected[:,&#39;y&#39;],marker=&#39;.&#39;,linestyle=&#39;&#39;,color=&#39;m&#39;)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;track_path/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>

        <span class="c1"># clean map</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">l</span><span class="p">);</span> <span class="n">l</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span> <span class="k">del</span> <span class="n">l</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">plot_all_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">out_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">start_point</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot all tracks found in the dataset</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            out_name: str, default=None</span>
<span class="sd">                filename under which the plot is saved. If None, it is saved in `self.working_dir`</span>
<span class="sd">            start_point: bool, default=True</span>
<span class="sd">                if True, start point of the track is highlighted</span>
<span class="sd">            facecolor: str, default=&quot;none&quot;</span>
<span class="sd">                background color of the saved plot</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tmp</span><span class="p">,</span><span class="n">txt</span><span class="o">=</span><span class="p">[],[]</span>
        <span class="k">if</span> <span class="n">out_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;season_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_found_tracks_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;season &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">)</span><span class="c1">#</span>

        <span class="n">summary</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:[],</span><span class="mi">1</span><span class="p">:[],</span><span class="mi">2</span><span class="p">:[],</span><span class="mi">3</span><span class="p">:[],</span><span class="mi">4</span><span class="p">:[],</span><span class="mi">5</span><span class="p">:[]}</span>
        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span><span class="n">track</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;t&#39;</span><span class="p">]),:]</span>
            <span class="k">if</span> <span class="n">start_point</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
                <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])],</span><span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">))</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
            <span class="n">tmp</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">cat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">summary</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_tc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">storm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="o">.</span><span class="n">storm</span><span class="p">)):</span>
                <span class="n">tmp</span><span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="p">[</span><span class="n">storm</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lat</span><span class="p">[</span><span class="n">storm</span><span class="p">,:],</span><span class="n">cat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_intens</span><span class="p">[</span><span class="n">storm</span><span class="p">,:],</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;wind&#39;</span><span class="p">),</span><span class="n">latlon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


        <span class="n">summary</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cat</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">keys</span><span class="p">(),[</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.91</span><span class="p">,</span><span class="mf">0.87</span><span class="p">,</span><span class="mf">0.83</span><span class="p">]):</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_cat_names</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="n">cat</span><span class="p">])),</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cat_colors</span><span class="p">[</span><span class="n">cat</span><span class="p">],</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">)</span>

        <span class="c1"># clean map</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">l</span><span class="p">);</span> <span class="n">l</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span> <span class="k">del</span> <span class="n">l</span>

<div class="viewcode-block" id="tc_tracks.plot_detect_summary"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.plot_detect_summary">[docs]</a>    <span class="k">def</span> <span class="nf">plot_detect_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">thr_wind</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span><span class="n">out_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots all storm snapshots detected in the dataset. Highlights warm core snapshots with red triangles and strong storm snapshots with yellwo triangles</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            thr_wind: float [m/s], default=17.5</span>
<span class="sd">                threshold used to differentiate between strom and weak storms</span>
<span class="sd">            out_name: str, default=None</span>
<span class="sd">                filename under which the plot is saved. If None, it is saved in `self.working_dir`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tmp</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">out_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;season_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_found_positions_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;season &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="p">)</span><span class="c1">#</span>

        <span class="n">detect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">detect</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">detect</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">))</span>
        <span class="n">warm_core</span><span class="o">=</span><span class="n">detect</span><span class="p">[</span><span class="n">detect</span><span class="p">[:,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">warm_core</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">warm_core</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
        <span class="n">strong_wind</span><span class="o">=</span><span class="n">detect</span><span class="p">[</span><span class="n">detect</span><span class="p">[:,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thr_wind</span><span class="p">]</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax</span><span class="p">,</span><span class="n">strong_wind</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">strong_wind</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>
        <span class="c1"># clean map</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">l</span><span class="p">);</span> <span class="n">l</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span> <span class="k">del</span> <span class="n">l</span></div>

<div class="viewcode-block" id="tc_tracks.plot_surrounding"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.plot_surrounding">[docs]</a>    <span class="k">def</span> <span class="nf">plot_surrounding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axes</span><span class="p">,</span><span class="n">time_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function plotting the four fields MSLP, Ta, WS and Vort for selected time steps. The function also highlights fulfilled warm core and strong storm conditions for detected snapshots. If observed data is loaded, information about observed storms is also added.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            axes: array of 4 cartopy.mpl.geoaxes.GeoAxesSubplot</span>
<span class="sd">                an array with 4 axes with cartopy projection. This ax object can be created with a command as `fig,axes=plt.subplots(nrows=2,ncols=2,figsize=(11.5,5),subplot_kw={&#39;projection&#39;: ccrs.PlateCarree()}); axes=axes.flatten()`</span>
<span class="sd">            time_steps: array of ints [indices of time axis], default=None</span>
<span class="sd">                time steps for which plots are created. If None, plots are created for all time steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">time_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span>

        <span class="c1">#plt.tight_layout()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_steps</span><span class="p">:</span>
            <span class="n">tmp</span><span class="p">,</span><span class="n">txt</span><span class="o">=</span><span class="p">[],[]</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;mean sea level pressure&#39;</span><span class="p">)</span>
            <span class="n">im</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:],</span><span class="n">vmin</span><span class="o">=</span><span class="mi">980</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1020</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;bone&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">)</span>
            <span class="n">im</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:],</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;bone&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;wind speed&#39;</span><span class="p">)</span>
            <span class="n">im</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_Wind10</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:],</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;bone&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VO</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;rel. Vorticity&#39;</span><span class="p">)</span>
                <span class="n">im</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_VO</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:],</span><span class="n">vmin</span><span class="o">=-</span><span class="mf">9.5</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">),</span><span class="n">vmax</span><span class="o">=</span><span class="mf">0.0002</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;bone&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;wind speed [m/s] and mslp [mbar]&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="p">[:,</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
                    <span class="n">stats</span><span class="o">=</span><span class="s1">&#39;wind: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="mi">01</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">mslp: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="mi">01</span><span class="p">))</span>
                    <span class="n">cat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">cat</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">txt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lons</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span><span class="n">stats</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cat_colors</span><span class="p">[</span><span class="n">cat</span><span class="p">],</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">point</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_on_map</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_tc</span><span class="p">:</span>
                <span class="n">obs_tc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_yr_frac</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="o">&lt;</span><span class="mf">0.0004</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_sel</span><span class="p">[</span><span class="s1">&#39;source_wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">oo</span><span class="p">],</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">oo</span><span class="p">],</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lon</span><span class="p">[</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">oo</span><span class="p">],</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">oo</span><span class="p">]],</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_lat</span><span class="p">[</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">oo</span><span class="p">],</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">oo</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cat_colors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_cat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tc_intens</span><span class="p">[</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">oo</span><span class="p">],</span><span class="n">obs_tc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">oo</span><span class="p">]],</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;wind&#39;</span><span class="p">)],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>


            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dates</span><span class="p">[</span><span class="n">t</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;track_surrounding/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">&#39;tight&#39;</span><span class="p">)</span>

            <span class="c1"># clean map</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">imm</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">l</span><span class="p">);</span> <span class="n">l</span><span class="o">.</span><span class="n">remove</span><span class="p">();</span> <span class="k">del</span> <span class="n">l</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">txt</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span></div>

    <span class="c1"># analyze fields</span>
<div class="viewcode-block" id="tc_tracks.get_box"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.get_box">[docs]</a>    <span class="k">def</span> <span class="nf">get_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">window</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds square around position</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            y: index</span>
<span class="sd">                center of square as an index of `self._lats` and `self._lons`</span>
<span class="sd">            x: index</span>
<span class="sd">                center of square as an index of `self._lats` and `self._lons`</span>
<span class="sd">            window:</span>
<span class="sd">                half of the length of the square</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            corners: tuple (y_min,y_max,x_min,x_max)</span>
<span class="sd">                corner coordinates of square</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_min</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">window</span><span class="p">))</span>
        <span class="n">y_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="o">+</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x_min</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="n">window</span><span class="p">))</span>
        <span class="n">x_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="o">+</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">y_min</span><span class="p">,</span><span class="n">y_max</span><span class="p">,</span><span class="n">x_min</span><span class="p">,</span><span class="n">x_max</span><span class="p">)</span></div>

<div class="viewcode-block" id="tc_tracks.area_around"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.area_around">[docs]</a>    <span class="k">def</span> <span class="nf">area_around</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">radius</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds area around position as ponints within a circle defining the area</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            y: index</span>
<span class="sd">                center of circle as an index of `self._lats` and `self._lons`</span>
<span class="sd">            x: index</span>
<span class="sd">                center of circle as an index of `self._lats` and `self._lons`</span>
<span class="sd">            window:</span>
<span class="sd">                radius of the circle</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            indices: tuple (y_,x_)</span>
<span class="sd">                y and x indices of points within circle defining the area</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_box</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">y_</span><span class="p">,</span><span class="n">x_</span><span class="o">=</span><span class="p">[],[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">&lt;=</span><span class="n">radius</span><span class="p">:</span>
                    <span class="n">y_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">x_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_</span><span class="p">,</span><span class="n">x_</span></div>

<div class="viewcode-block" id="tc_tracks.circle_around"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.circle_around">[docs]</a>    <span class="k">def</span> <span class="nf">circle_around</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">radius</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds circle around position</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            y: index</span>
<span class="sd">                center of circle as an index of `self._lats` and `self._lons`</span>
<span class="sd">            x: index</span>
<span class="sd">                center of circle as an index of `self._lats` and `self._lons`</span>
<span class="sd">            window:</span>
<span class="sd">                radius of the circle</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            indices: tuple (y_,x_)</span>
<span class="sd">                y and x indices of points on the circle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_box</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">y_</span><span class="p">,</span><span class="n">x_</span><span class="o">=</span><span class="p">[],[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">radius</span><span class="o">-</span><span class="mi">1</span><span class="o">&lt;=</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">&lt;=</span><span class="n">radius</span><span class="p">:</span>
                    <span class="n">y_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">x_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_</span><span class="p">,</span><span class="n">x_</span></div>

<div class="viewcode-block" id="tc_tracks.find_closed_contours"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.find_closed_contours">[docs]</a>    <span class="k">def</span> <span class="nf">find_closed_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">search_radius</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">n_contours</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function uses opencv to detect closed contours around a given point</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            field: np.array</span>
<span class="sd">                field in which contours are searched</span>
<span class="sd">            y:  int [index]</span>
<span class="sd">                latitude index within field of point around which contours are searched</span>
<span class="sd">            x:  int [index]</span>
<span class="sd">                longitude index within field of point around which contours are searched</span>
<span class="sd">            step: float,default=2</span>
<span class="sd">                step is added to the search threshold after each identified contour</span>
<span class="sd">            search_radius: int [lat/lon steps],</span>
<span class="sd">                maximal allowed radius for contours. If a contour touches this limit, the contour isn&#39;t considered as closed. Given in lat/lon steps</span>
<span class="sd">            n_contours: int, default=None</span>
<span class="sd">                If this is not None, the algorithm stops searching after `n_contours` are found</span>
<span class="sd">            method: str [&quot;min&quot; or &quot;max&quot;],default=&quot;min&quot;</span>
<span class="sd">                defines whether closed contours are searched around a minimum or a maximum</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            cont: np.array</span>
<span class="sd">                array containing a lat-lon mask for each found contour. Cells in contained in the contour are 1, other are nans.</span>
<span class="sd">            ncont: int</span>
<span class="sd">                number of found contours</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">y_min</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="n">search_radius</span><span class="p">))</span>
        <span class="n">y_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="o">+</span><span class="n">search_radius</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x_min</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="n">search_radius</span><span class="p">))</span>
        <span class="n">x_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="o">+</span><span class="n">search_radius</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;min&#39;</span><span class="p">:</span>
            <span class="n">im</span><span class="o">=-</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">threshold</span><span class="o">=-</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">field</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>

        <span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">running</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">ncont</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">cont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">n_contours</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ncont</span><span class="o">&lt;</span><span class="n">n_contours</span><span class="p">:</span>
            <span class="n">threshold</span><span class="o">-=</span><span class="n">step</span>
            <span class="n">th</span><span class="p">,</span> <span class="n">im_floodfill</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">);</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">nx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">floodFill</span><span class="p">(</span><span class="n">im_floodfill</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">y_</span><span class="p">,</span><span class="n">x_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y_min</span> <span class="ow">in</span> <span class="n">y_</span> <span class="ow">or</span> <span class="n">x_min</span> <span class="ow">in</span> <span class="n">x_</span> <span class="ow">or</span> <span class="n">y_max</span><span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">y_</span> <span class="ow">or</span> <span class="n">x_max</span><span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">x_</span><span class="p">:</span>
                <span class="n">cont</span><span class="p">[</span><span class="n">cont</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">return</span> <span class="n">cont</span><span class="p">,</span><span class="n">ncont</span>
            <span class="n">cont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">ncont</span><span class="o">+=</span><span class="mi">1</span>

        <span class="n">cont</span><span class="p">[</span><span class="n">cont</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">cont</span><span class="p">,</span><span class="n">ncont</span></div>

    <span class="c1"># combine detected positions</span>
<div class="viewcode-block" id="tc_tracks.combine_tracks"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.combine_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">combine_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_radius</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">total_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">warm_steps</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">strong_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">consecutive_warm_strong_steps</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">thr_wind</span><span class="o">=</span><span class="mf">17.5</span><span class="p">,</span> <span class="n">smooth_path_angle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">velocity_jump</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">lat_formation_cutoff</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines detected storm snapshots from :meth:`detect_contours` or :meth:`detect_knutson2007` into storm tracks.</span>

<span class="sd">        In a first step, starting with the storm snapshot with lowest MSLP, storm snapshots in the following and preceding time steps are added to the track if they are located within the `search_radius`. If multiple snapshots are found within the `search_radius` the one with lowest MSLP is selected. If a landmask was provided, all storm snapshots located over land are deleted from the beginning of the track. Finally if the track fullfills a set of conditions, it is saved.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            search_radius: float [deg],default=6</span>
<span class="sd">                maximal allowed distance between two storm snapshots of consecutive time steps</span>
<span class="sd">            total_steps: int, default=12</span>
<span class="sd">                minimal number of steps required for the track to be saved</span>
<span class="sd">            warm_steps: int, default=8</span>
<span class="sd">                minimal number of warm core steps required for the track to be saved</span>
<span class="sd">            strong_steps: int, default=0</span>
<span class="sd">                minimal number of time steps with wind speeds above `thr_wind` required for the track to be saved</span>
<span class="sd">            consecutive_warm_strong_steps: int, default=6</span>
<span class="sd">                minimal number of consecutive warm core steps with wind speeds above `thr_wind` required for the track to be saved</span>
<span class="sd">            thr_wind:   float [m/s],default=17.5</span>
<span class="sd">                threshold above which a storm snapshot is considered to be a strong storm (relevant for `strong_steps`)</span>
<span class="sd">            lat_formation_cutoff, float [deg], default=40</span>
<span class="sd">                maximal allowed latitude for storm formation</span>
<span class="sd">            overwrite: bool, default=False</span>
<span class="sd">                if False, existing outputfiles of the function are loaded, if True they are overwritten</span>
<span class="sd">            plot:  bool, default=True</span>
<span class="sd">                create a plot of each saved track</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            self._tcs: dimarray</span>
<span class="sd">                a dimarray containg time, position and characteristics of each track</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;track_info_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm &#39;</span><span class="o">+</span><span class="n">out_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">overwrite</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">read_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span>

        <span class="k">def</span> <span class="nf">v_len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">zz</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">zz</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="k">def</span> <span class="nf">consecutive_sequence</span><span class="p">(</span><span class="n">zz</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span><span class="n">su</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,[]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">zz</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">zz</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">su</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">su</span><span class="p">,</span><span class="n">su</span><span class="p">))</span>
                    <span class="n">su</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">su</span><span class="p">,</span><span class="n">su</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="c1"># convert distances from degrees into grid-cells</span>
        <span class="n">search_radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">search_radius</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span><span class="o">=</span><span class="p">{}</span>

        <span class="n">postions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">used_pos</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1"># # sort for decreasing 10m Wind speed</span>
        <span class="c1"># for p in postions[postions[:,-1].argsort()[::-1],:].tolist():</span>
        <span class="c1"># sort for minimal mslp</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">postions</span><span class="p">[</span><span class="n">postions</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_pos</span><span class="p">:</span>
                <span class="n">track</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

                <span class="n">running</span><span class="o">=</span><span class="kc">True</span>
                <span class="c1">#go backwards</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">prev_step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prev_step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">track</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">track</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">candidates</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">p_1</span> <span class="ow">in</span> <span class="n">postions</span><span class="p">[</span><span class="n">postions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">new_step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">p_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">v_len</span><span class="p">(</span><span class="n">new_step</span><span class="o">-</span><span class="n">prev_step</span><span class="p">)</span><span class="o">&lt;</span><span class="n">search_radius</span><span class="p">:</span> <span class="c1"># and self._land_mask[int(p_1[1]),int(p_1[2])]</span>
                            <span class="c1"># # exclude strong direction changes if TC isn&#39;t extremely slow</span>
                            <span class="c1"># if v_len(prev_step)/v_len(new_step-prev_step)&lt;1/velocity_jump and angle_between(new_step,prev_step)&gt;smooth_path_angle:</span>
                            <span class="c1">#     # strange movement</span>
                            <span class="c1">#     pass</span>
                            <span class="c1"># else:</span>
                            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_1</span><span class="p">)</span>
                            <span class="n">end</span><span class="o">=</span><span class="kc">False</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># select snapshot with lowest mslp</span>
                        <span class="n">track</span><span class="o">=</span><span class="p">[</span><span class="n">candidates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candidates</span><span class="p">)[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]]</span><span class="o">+</span><span class="n">track</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="c1">#go forewards</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">prev_step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prev_step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">track</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">track</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">candidates</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">p_1</span> <span class="ow">in</span> <span class="n">postions</span><span class="p">[</span><span class="n">postions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">new_step</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">p_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p_1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">v_len</span><span class="p">(</span><span class="n">new_step</span><span class="o">-</span><span class="n">prev_step</span><span class="p">)</span><span class="o">&lt;</span><span class="n">search_radius</span><span class="p">:</span>
                            <span class="c1"># # exclude strong direction changes if TC isn&#39;t extremely slow</span>
                            <span class="c1"># if v_len(prev_step)/v_len(new_step-prev_step)&lt;1/velocity_jump and angle_between(new_step,prev_step)&gt;smooth_path_angle:</span>
                            <span class="c1">#     # strange movement</span>
                            <span class="c1">#     pass</span>
                            <span class="c1"># else:</span>
                            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_1</span><span class="p">)</span>
                            <span class="n">end</span><span class="o">=</span><span class="kc">False</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># select snapshot with lowest mslp</span>
                        <span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="o">+</span><span class="p">[</span><span class="n">candidates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candidates</span><span class="p">)[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="c1"># delete land steps in the beginning of track</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_land_mask</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])]:</span>
                        <span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="c1"># check whether the track should be saved</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pp</span> <span class="ow">in</span> <span class="n">used_pos</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">track</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">track</span><span class="p">))</span><span class="o">&lt;</span><span class="mf">0.3</span><span class="p">:</span>
                        <span class="n">used_pos</span><span class="o">+=</span><span class="n">track</span>

                        <span class="n">track</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">DimArray</span><span class="p">(</span><span class="n">track</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">track</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;pressure_low&#39;</span><span class="p">,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
                        <span class="n">save_track</span><span class="o">=</span><span class="kc">True</span>
                        <span class="n">start_pos</span><span class="o">=</span><span class="n">track</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">track</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">total_steps</span><span class="p">:</span>
                            <span class="n">save_track</span><span class="o">=</span><span class="kc">False</span>
                        <span class="k">if</span> <span class="n">track</span><span class="p">[</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">warm_steps</span><span class="p">:</span>
                            <span class="n">save_track</span><span class="o">=</span><span class="kc">False</span>
                        <span class="k">elif</span> <span class="n">track</span><span class="p">[</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">start_pos</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">track</span><span class="p">[</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thr_wind</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">strong_steps</span><span class="p">:</span>
                            <span class="n">save_track</span><span class="o">=</span><span class="kc">False</span>
                        <span class="k">elif</span> <span class="n">track</span><span class="p">[</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thr_wind</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">start_pos</span><span class="o">=</span><span class="n">track</span><span class="p">[</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thr_wind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">consecutive_warm_strong_steps</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">warm_strong</span><span class="o">=</span><span class="n">track</span><span class="p">[(</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">thr_wind</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">track</span><span class="p">[:,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span>
                            <span class="n">consecutive</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">warm_strong</span><span class="p">[:,</span><span class="s1">&#39;t&#39;</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
                            <span class="n">consec_info</span><span class="o">=</span><span class="n">consecutive_sequence</span><span class="p">(</span><span class="n">consecutive</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">consec_info</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="n">consecutive_warm_strong_steps</span><span class="p">:</span>
                                <span class="n">save_track</span><span class="o">=</span><span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">first_of_consec</span><span class="o">=</span><span class="n">consec_info</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">consec_info</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">start_pos</span><span class="o">=</span><span class="n">warm_strong</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">first_of_consec</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lats</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">start_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">start_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">&gt;=</span><span class="n">lat_formation_cutoff</span><span class="p">:</span>
                            <span class="n">save_track</span><span class="o">=</span><span class="kc">False</span>

                        <span class="k">if</span> <span class="n">save_track</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)]</span><span class="o">=</span><span class="n">track</span>
                            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">plot_track_path</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">+=</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span><span class="o">.</span><span class="n">write_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tcs</span></div>

    <span class="c1"># detect positions</span>
<div class="viewcode-block" id="tc_tracks.detect_contours"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.detect_contours">[docs]</a>    <span class="k">def</span> <span class="nf">detect_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">p_radius</span><span class="o">=</span><span class="mi">27</span><span class="p">,</span><span class="n">p_inc_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">warm_core_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">T_drop_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dis_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dis_mslp_min</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This detection algorithm is a adapted from Murakami 2015.</span>
<span class="sd">        The method is based on the detection mean sea level pressure (MSLP) minima. If closed contours in MSLP are found around a minimum (using :meth:`find_closed_contours`), the minimum is taken as storm center. Within a radius of `dis_cores` the maximum in temperature anomaly (Ta) is suspected to be the warm core of the storm. If a closed  contour in Ta is found around the maximum in Ta, the storm is treated as a warm core storm snapshot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            dis_mslp_min:   float [deg],default=3</span>
<span class="sd">                minimal allowed distance between detected mslp minima</span>
<span class="sd">            p_radius:       float [deg],defualt=27</span>
<span class="sd">                maximum radius for mslp closed contours</span>
<span class="sd">            p_inc_step:     float [hPa],default=1</span>
<span class="sd">                step for mslp contours</span>
<span class="sd">            warm_core_size: float [deg],default=3</span>
<span class="sd">                maximal radius of warm core contours</span>
<span class="sd">            T_drop_step:    float [K],default=1</span>
<span class="sd">                step for Ta contours</span>
<span class="sd">            dis_cores:      float [deg],default=1</span>
<span class="sd">                maximal distances between vort max and mslp min (mslp min and warm core)</span>
<span class="sd">            overwrite:      bool,default=False</span>
<span class="sd">                if False, existing outputfiles of the function are loaded, if True they are overwritten</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            self._detected: dimarray</span>
<span class="sd">                time, position and characteristics of detected snapshots</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">=</span><span class="s1">&#39;contours&#39;</span>
        <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;detected_positions_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm &#39;</span><span class="o">+</span><span class="n">out_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">overwrite</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">read_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">)[</span><span class="s1">&#39;detected&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span>

        <span class="c1"># convert distances from degrees into grid-cells</span>
        <span class="n">dis_mslp_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">dis_mslp_min</span><span class="p">)</span>
        <span class="n">p_radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">p_radius</span><span class="p">)</span>
        <span class="n">dis_cores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">dis_cores</span><span class="p">)</span>
        <span class="n">warm_core_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">warm_core_size</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="n">detect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;detecting</span><span class="se">\n</span><span class="s1">10------50-------100&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">progress</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span><span class="p">)]):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">progress</span><span class="p">);</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">peak_local_max</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP_smoothed</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:],</span> <span class="n">min_distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dis_mslp_min</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">tc_area</span><span class="p">,</span><span class="n">ncont</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_closed_contours</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP_smoothed</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:],</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="n">p_inc_step</span><span class="p">,</span><span class="n">search_radius</span><span class="o">=</span><span class="n">p_radius</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ncont</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># have to check boundary issues here</span>
                    <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_box</span><span class="p">(</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">,</span><span class="n">dis_cores</span><span class="p">)</span>
                    <span class="n">y_</span><span class="p">,</span><span class="n">x_</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">y_t</span><span class="p">,</span><span class="n">x_t</span><span class="o">=</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">y_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">x_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">warm_core_area</span><span class="p">,</span><span class="n">ncont</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_closed_contours</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:],</span><span class="n">y_t</span><span class="p">,</span><span class="n">x_t</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="n">T_drop_step</span><span class="p">,</span><span class="n">search_radius</span><span class="o">=</span><span class="n">p_radius</span><span class="p">,</span><span class="n">n_contours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
                    <span class="n">yy</span><span class="p">,</span><span class="n">xx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">warm_core_area</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">warm_core_area</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;</span><span class="n">warm_core_size</span> <span class="ow">and</span> <span class="n">ncont</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

                    <span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">]</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">tc_area</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_Wind10</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:])</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">ncont</span><span class="p">)</span>
                    <span class="n">detect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">detect</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tmp</span><span class="p">])))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">DimArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">detect</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]),</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">detect</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;pressure_low&#39;</span><span class="p">,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        <span class="n">da</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;detected&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="p">})</span><span class="o">.</span><span class="n">write_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span></div>

<div class="viewcode-block" id="tc_tracks.detect_knutson2007"><a class="viewcode-back" href="../content.html#TC_detection.tc_tracks.detect_knutson2007">[docs]</a>    <span class="k">def</span> <span class="nf">detect_knutson2007</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">thr_vort</span><span class="o">=</span><span class="mf">3.5</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">),</span><span class="n">dis_vort_max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">dis_cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">thr_MSLP_inc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">dis_MSLP_inc</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">thr_T_drop</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">dis_T_drop</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">tc_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Detection based on thresholds</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            thr_vort:       float [1/s],default=3.5*10**(-5)</span>
<span class="sd">                threshold for relative vorticity maxima</span>
<span class="sd">            dis_vort_max:   float [deg],default=4</span>
<span class="sd">                minimal distance between vorticity maxima</span>
<span class="sd">            dis_cores:      float [deg],default=2</span>
<span class="sd">                maximal distances between vort max and mslp min (mslp min and warm core)</span>
<span class="sd">            thr_MSLP_inc:   float [hPa],default=4</span>
<span class="sd">                increase in MSLP from center over dis_MSLP_inc</span>
<span class="sd">            dis_MSLP_inc:   float [deg],default=5</span>
<span class="sd">                distance over which MSLP should increase by thr_MSLP_inc</span>
<span class="sd">            thr_T_drop:     float [K],default=0.8</span>
<span class="sd">                temperature drop from warm core center over dis_T_decrease</span>
<span class="sd">            dis_T_drop:     float [deg],default=5</span>
<span class="sd">                distance over which T should decrease by thr_T_decrease</span>
<span class="sd">            tc_size:        float [deg],default=7</span>
<span class="sd">                radius within which maximal Wind10 is searched for</span>
<span class="sd">            overwrite:      bool,default=False</span>
<span class="sd">                if False, existing outputfiles of the function are loaded, if True they are overwritten</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            self._detected: dimarray</span>
<span class="sd">                time, position and characteristics of detected snapshots</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">=</span><span class="s1">&#39;knutson2007&#39;</span>
        <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_working_dir</span><span class="o">+</span><span class="s1">&#39;detected_positions_thresholds_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_name</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm &#39;</span><span class="o">+</span><span class="n">out_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">overwrite</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">read_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">)[</span><span class="s1">&#39;detected&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span>

        <span class="c1"># convert distances from degrees into grid-cells</span>
        <span class="n">dis_vort_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">dis_vort_max</span><span class="p">))</span>
        <span class="n">dis_cores</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">dis_cores</span><span class="p">))</span>
        <span class="n">dis_MSLP_inc</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">dis_MSLP_inc</span><span class="p">))</span>
        <span class="n">dis_T_drop</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">dis_T_drop</span><span class="p">))</span>
        <span class="n">tc_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_to_step</span><span class="p">(</span><span class="n">tc_size</span><span class="p">))</span>

        <span class="n">detect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;detecting</span><span class="se">\n</span><span class="s1">10------50-------100&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">progress</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_i</span><span class="p">)]):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">progress</span><span class="p">);</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># i vort max</span>
            <span class="n">vo_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_VO</span><span class="p">[</span><span class="n">t</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vo_</span><span class="p">[</span><span class="n">vo_</span><span class="o">&lt;</span><span class="n">thr_vort</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">vo_</span><span class="p">,</span> <span class="n">min_distance</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dis_vort_max</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">y_v</span><span class="p">,</span><span class="n">x_v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">area_around</span><span class="p">(</span><span class="n">y_v</span><span class="p">,</span><span class="n">x_v</span><span class="p">,</span><span class="n">dis_cores</span><span class="p">)</span>
                    <span class="n">p_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_window</span><span class="o">==</span><span class="n">p_window</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span> <span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="o">=</span><span class="n">y_circ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x_circ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">dis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dis_MSLP_inc</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">circle_around</span><span class="p">(</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">,</span><span class="n">dis</span><span class="p">)</span>
                        <span class="c1"># ii relative pressure min</span>
                        <span class="c1"># could also be self._MSLP[t,y_circ,x_circ].mean()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">]</span><span class="o">&gt;</span><span class="n">thr_MSLP_inc</span><span class="p">:</span>
                            <span class="n">tmp</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">area_around</span><span class="p">(</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">,</span><span class="n">dis_cores</span><span class="p">)</span>
                            <span class="c1"># iv warm core</span>
                            <span class="n">t_window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                            <span class="n">i</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t_window</span><span class="o">==</span><span class="n">t_window</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span> <span class="n">y_t</span><span class="p">,</span><span class="n">x_t</span><span class="o">=</span><span class="n">y_circ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x_circ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">dis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dis_T_drop</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">circle_around</span><span class="p">(</span><span class="n">y_t</span><span class="p">,</span><span class="n">x_t</span><span class="p">,</span><span class="n">dis</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_t</span><span class="p">,</span><span class="n">x_t</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_T</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="n">thr_T_drop</span><span class="p">:</span>
                                    <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                            <span class="c1"># iii wind speed</span>
                            <span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_MSLP</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">]</span>
                            <span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">area_around</span><span class="p">(</span><span class="n">y_p</span><span class="p">,</span><span class="n">x_p</span><span class="p">,</span><span class="n">tc_size</span><span class="p">)</span>
                            <span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Wind10</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">y_circ</span><span class="p">,</span><span class="n">x_circ</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                            <span class="n">detect</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">detect</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tmp</span><span class="p">])))</span>
                            <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">DimArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">detect</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]),</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">detect</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;pressure_low&#39;</span><span class="p">,</span><span class="s1">&#39;warm_core&#39;</span><span class="p">,</span><span class="s1">&#39;MSLP&#39;</span><span class="p">,</span><span class="s1">&#39;Wind10&#39;</span><span class="p">]],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        <span class="n">da</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;detected&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_detected</span><span class="p">})</span><span class="o">.</span><span class="n">write_nc</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detected</span></div></div>

    <span class="c1"># pld stuff</span>
    <span class="c1"># def detect_thresholds_simple(self,thr_vort=3.5*10**(-5),dis_vort_max=4,dis_cores=2,thr_MSLP_inc=2,dis_MSLP_inc=5,thr_T_drop=1,dis_T_drop=3,tc_size=5,overwrite=False):</span>
    <span class="c1">#     self._add_name=&#39;thresholds&#39;</span>
    <span class="c1">#     out_file=self._working_dir+&#39;detected_positions_thresholds_&#39;+self._add_name+&#39;.nc&#39;</span>
    <span class="c1">#     if overwrite and os.path.isfile(out_file):</span>
    <span class="c1">#         os.system(&#39;rm &#39;+out_file)</span>
    <span class="c1">#     elif overwrite==False and os.path.isfile(out_file):</span>
    <span class="c1">#         self._detected=da.read_nc(out_file)[&#39;detected&#39;]</span>
    <span class="c1">#         return self._detected</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Required Thresholds:</span>
    <span class="c1">#     thr_vort:       float [1/s]:    threshold for relative vorticity maxima</span>
    <span class="c1">#     dis_vort_max:   float [deg]:    minimal distance between vorticity maxima</span>
    <span class="c1">#     dis_cores:      float [deg]:    maximal distances between vort max and mslp min (mslp min and warm core)</span>
    <span class="c1">#     dis_MSLP_inc:   float [deg]:    distance over which MSLP should increase by thr_MSLP_inc</span>
    <span class="c1">#     thr_T_drop:     float [K]:      temperature drop from warm core center over dis_T_decrease</span>
    <span class="c1">#     dis_T_drop:     float [deg]:    distance over which T should decrease by thr_T_decrease</span>
    <span class="c1">#     tc_size:        float [deg]:    radius within which maximal Wind10 is searched for</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#     # convert distances from degrees into grid-cells</span>
    <span class="c1">#     for distance in [dis_vort_max,dis_cores,dis_MSLP_inc,dis_T_drop,tc_size]:</span>
    <span class="c1">#         distance=self.degree_to_step(distance)</span>
    <span class="c1">#</span>
    <span class="c1">#     detect=np.array([[np.nan]*7])</span>
    <span class="c1">#     print(&#39;detecting\n10------50-------100&#39;)</span>
    <span class="c1">#     for t,progress in zip(self._time_i,np.array([[&#39;-&#39;]+[&#39;&#39;]*(len(self._time_i)/20+1)]*20).flatten()[0:len(self._time_i)]):</span>
    <span class="c1">#         sys.stdout.write(progress); sys.stdout.flush()</span>
    <span class="c1">#         # i vort max</span>
    <span class="c1">#         vo_=self._VO[t,:,:].copy()</span>
    <span class="c1">#         vo_[vo_&lt;thr_vort]=0</span>
    <span class="c1">#         coords = peak_local_max(vo_, min_distance=int(dis_vort_max))</span>
    <span class="c1">#         if coords.shape[0]&gt;0:</span>
    <span class="c1">#             for y_v,x_v in zip(coords[:,0],coords[:,1]):</span>
    <span class="c1">#                 y_circ,x_circ=self.area_around(y_v,x_v,dis_cores)</span>
    <span class="c1">#                 p_window=self._MSLP[t,y_circ,x_circ].flatten()</span>
    <span class="c1">#                 i=np.where(p_window==p_window.min())[0][0]; y_p,x_p=y_circ[i],x_circ[i]</span>
    <span class="c1">#                 y_area,x_area=self.area_around(y_p,x_p,dis_MSLP_inc)</span>
    <span class="c1">#                 # ii relative pressure min</span>
    <span class="c1">#                 if self._MSLP[t,y_p,x_p]==self._MSLP[t,y_area,x_area].min():</span>
    <span class="c1">#                     box_1=self.get_box(y_p,x_p,cores_distance)</span>
    <span class="c1">#                     box_2=self.get_box(y_p,x_p,tc_size)</span>
    <span class="c1">#                     tmp=[t,y_p,x_p,1,0,0,0]</span>
    <span class="c1">#                     # iv warm core</span>
    <span class="c1">#                     if self._T is None:</span>
    <span class="c1">#                         tmp[4]=1</span>
    <span class="c1">#                     elif self._T[t,1,box_1[0]:box_1[1],box_1[2]:box_1[3]].max()-self._T[t,1,box_2[0]:box_2[1],box_2[2]:box_2[3]].mean()&gt;thr_T_drop:</span>
    <span class="c1">#                         tmp[4]=1</span>
    <span class="c1">#                     # iii wind speed</span>
    <span class="c1">#                     tmp[5]=self._MSLP[t,y_p,x_p]</span>
    <span class="c1">#                     tmp[6]=self._Wind10[t,box_2[0]:box_2[1],box_2[2]:box_2[3]].max()</span>
    <span class="c1">#                     detect=np.concatenate((detect,np.array([tmp])))</span>
    <span class="c1">#</span>
    <span class="c1">#     self._detected=da.DimArray(np.array(detect[1:,:]),axes=[range(detect.shape[0]-1),[&#39;t&#39;,&#39;y&#39;,&#39;x&#39;,&#39;pressure_low&#39;,&#39;warm_core&#39;,&#39;MSLP&#39;,&#39;Wind10&#39;]],dims=[&#39;ID&#39;,&#39;z&#39;])</span>
    <span class="c1">#     da.Dataset({&#39;detected&#39;:self._detected}).write_nc(out_file,mode=&#39;w&#39;)</span>
    <span class="c1">#     print(&#39;done&#39;)</span>
    <span class="c1">#     return self._detected</span>
    <span class="c1">#</span>
    <span class="c1"># def detect_hybrid(self,overwrite=False,thr_vort=5*10**(-5),dis_vort_max=4,p_radius=27,p_inc_step=1,warm_core_size=3,T_drop_step=1,dis_cores=1,dis_mslp_min=3):</span>
    <span class="c1">#     self._add_name=&#39;hybrid&#39;</span>
    <span class="c1">#     out_file=self._working_dir+&#39;detected_positions_&#39;+self._add_name+&#39;.nc&#39;</span>
    <span class="c1">#     if overwrite and os.path.isfile(out_file):</span>
    <span class="c1">#         os.system(&#39;rm &#39;+out_file)</span>
    <span class="c1">#     elif overwrite==False and os.path.isfile(out_file):</span>
    <span class="c1">#         self._detected=da.read_nc(out_file)[&#39;detected&#39;]</span>
    <span class="c1">#         return self._detected</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     Required Thresholds:</span>
    <span class="c1">#     dis_vort_max:   float [deg]:    minimal distance between vort maxima</span>
    <span class="c1">#     p_radius:       float [deg]:    maximum radius for mslp closed contours</span>
    <span class="c1">#     p_inc_step:     float [hPa]:    step for mslp contours</span>
    <span class="c1">#     warm_core_size: float [deg]:    maximal radius of warm core contours</span>
    <span class="c1">#     T_drop_step:    float [K]:      step for Ta contours</span>
    <span class="c1">#     dis_cores:      float [deg]:    maximal distances between vort max and mslp min (mslp min and warm core)</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#     # convert distances from degrees into grid-cells</span>
    <span class="c1">#     p_radius=self.degree_to_step(p_radius)</span>
    <span class="c1">#     dis_cores=self.degree_to_step(dis_cores)</span>
    <span class="c1">#     warm_core_size=self.degree_to_step(warm_core_size)**2*2*np.pi</span>
    <span class="c1">#     dis_vort_max=int(self.degree_to_step(dis_vort_max))</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#     detect=np.array([[np.nan]*7])</span>
    <span class="c1">#     print(&#39;detecting\n10------50-------100&#39;)</span>
    <span class="c1">#     for t,progress in zip(self._time_i,np.array([[&#39;-&#39;]+[&#39;&#39;]*(len(self._time_i)/20+1)]*20).flatten()[0:len(self._time_i)]):</span>
    <span class="c1">#         sys.stdout.write(progress); sys.stdout.flush()</span>
    <span class="c1">#</span>
    <span class="c1">#         vo_=self._VO[t,:,:].copy()</span>
    <span class="c1">#         vo_[vo_&lt;thr_vort]=0</span>
    <span class="c1">#         coords = peak_local_max(vo_, min_distance=int(dis_vort_max))</span>
    <span class="c1">#         if coords.shape[0]&gt;0:</span>
    <span class="c1">#             for y_v,x_v in zip(coords[:,0],coords[:,1]):</span>
    <span class="c1">#                 y_circ,x_circ=self.area_around(y_v,x_v,dis_cores)</span>
    <span class="c1">#                 # get small area around vort max</span>
    <span class="c1">#                 p_window=self._MSLP_smoothed[t,y_circ,x_circ].flatten()</span>
    <span class="c1">#                 # MSLP min next to vort max is center</span>
    <span class="c1">#                 i=np.where(p_window==p_window.min())[0][0]; y_p,x_p=y_circ[i],x_circ[i]</span>
    <span class="c1">#                 # find closed contours around MSLP min</span>
    <span class="c1">#                 tc_area,ncont=self.find_closed_contours(self._MSLP_smoothed[t,:,:],y_p,x_p,step=p_inc_step,search_radius=p_radius,method=&#39;min&#39;)</span>
    <span class="c1">#                 if ncont&gt;0:</span>
    <span class="c1">#                     tmp=[t,y_p,x_p,1,0,0,0]</span>
    <span class="c1">#                     # find warm core center</span>
    <span class="c1">#                     box=self.get_box(y_p,x_p,dis_cores)</span>
    <span class="c1">#                     y_,x_=np.where(self._T[t,box[0]:box[1],box[2]:box[3]]==self._T[t,box[0]:box[1],box[2]:box[3]].max())</span>
    <span class="c1">#                     y_t,x_t=box[0]+y_[0],box[2]+x_[0]</span>
    <span class="c1">#                     # check if warm core exists</span>
    <span class="c1">#                     warm_core_area,ncont=self.find_closed_contours(self._T[t,:,:],y_t,x_t,step=T_drop_step,search_radius=p_radius,n_contours=1,method=&#39;max&#39;)</span>
    <span class="c1">#                     yy,xx=np.where(warm_core_area==1)</span>
    <span class="c1">#                     if len(np.where(warm_core_area==1)[0])&lt;warm_core_size and ncont==1:</span>
    <span class="c1">#                         tmp[4]=1</span>
    <span class="c1">#</span>
    <span class="c1">#                     tmp[5]=self._MSLP[t,y_p,x_p]</span>
    <span class="c1">#                     # tc area is defined by closed contours</span>
    <span class="c1">#                     tmp[6]=np.nanmax(tc_area*self._Wind10[t,:,:])</span>
    <span class="c1">#                     detect=np.concatenate((detect,np.array([tmp])))</span>
    <span class="c1">#</span>
    <span class="c1">#     self._detected=da.DimArray(np.array(detect[1:,:]),axes=[range(detect.shape[0]-1),[&#39;t&#39;,&#39;y&#39;,&#39;x&#39;,&#39;pressure_low&#39;,&#39;warm_core&#39;,&#39;MSLP&#39;,&#39;Wind10&#39;]],dims=[&#39;ID&#39;,&#39;z&#39;])</span>
    <span class="c1">#     da.Dataset({&#39;detected&#39;:self._detected}).write_nc(out_file,mode=&#39;w&#39;)</span>
    <span class="c1">#     print(&#39;done&#39;)</span>
    <span class="c1">#     return self._detected</span>

    <span class="c1"># def set_thresholds(self,thr_wind,thr_mslp,p_radius,neighborhood_size,warm_core_size,cores_distance,search_radius,min_time_steps):</span>
    <span class="c1">#     self._thr_wind=thr_wind</span>
    <span class="c1">#     self._thr_mslp=thr_mslp</span>
    <span class="c1">#     self._min_time_steps=min_time_steps</span>
    <span class="c1">#</span>
    <span class="c1">#     self._p_radius=self.degree_to_step(p_radius)</span>
    <span class="c1">#     self._neighborhood_size=self.degree_to_step(neighborhood_size)</span>
    <span class="c1">#     self._warm_core_size=self.degree_to_step(warm_core_size)**2</span>
    <span class="c1">#     self._cores_distance=self.degree_to_step(cores_distance)</span>
    <span class="c1">#     self._search_radius=self.degree_to_step(search_radius)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Peter Pfleiderer.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>